<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>R·∫Øn sƒÉn m·ªìi ‚Äî XUANHOANGVIETANH</title>

  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;600;700;900&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --cream:#F4EEDC; --paper:#FFF8E8; --olive:#586A4A; --olive-2:#415238;
      --stroke:rgba(0,0,0,.06); --shadow:0 14px 36px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:"Fira Sans", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--cream); color:#263021; display:flex;align-items:center;justify-content:center; padding:18px;
    }
    .frame{
      width:760px; max-width:96vw; background:linear-gradient(180deg, var(--paper), #FFF2D4);
      border:1px solid var(--stroke); border-radius:28px; box-shadow:var(--shadow); padding:20px; position:relative; overflow:hidden;
    }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; padding-inline:6px; }
    .title{ font-weight:900; letter-spacing:.02em; color:var(--olive-2); font-size:22px; }
    .meta{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .badge{ background:var(--olive); color:#fff; padding:6px 12px; border-radius:12px; font-weight:700; font-size:14px; box-shadow:0 8px 18px rgba(88,106,74,.32); }
    .goal{ font-size:13px; color:#4a5a43; opacity:.9; }
    .board{ display:grid; place-items:center; gap:10px; }
    canvas{
      width:600px; height:600px; background:#f7f1df; border-radius:22px; border:1px solid rgba(0,0,0,.05);
      box-shadow: inset 0 0 0 6px rgba(233,223,194,.8), 0 10px 26px rgba(0,0,0,.12);
      image-rendering: pixelated; display:block; max-width:92vw; max-height:92vw;
    }
    .progress-wrap{ width:600px; max-width:92vw; background:#efe7cf; border:1px solid rgba(0,0,0,.06); border-radius:999px; height:10px; overflow:hidden; }
    .progress{ height:100%; width:0%; background:linear-gradient(90deg, var(--olive), #6f835d); transition:width .25s ease; }
    footer{ margin-top:8px; text-align:center; font-size:12px; color:#53614a; opacity:.9; }

    /* Overlay */
    .overlay{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter: blur(6px); background: rgba(255,255,255,.35); z-index:10; }
    .card{
      background:#ffffffd9; border:1px solid rgba(0,0,0,.05); border-radius:24px; padding:22px 26px; text-align:center; color:#2b3a2a;
      box-shadow:0 24px 50px rgba(0,0,0,.18); width:min(520px, 90%);
    }
    .card h2{ color:var(--olive-2); font-size:26px; margin-bottom:8px; font-weight:900; }
    .card p{ font-size:14px; color:#4a5a43; margin-bottom:14px; }
    .inp{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(0,0,0,.12); background:#fff; outline:none; font-weight:700; text-transform:uppercase; text-align:center; }
    .cta{ margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .btn{ padding:12px 16px; border-radius:14px; border:none; cursor:pointer; font-weight:800; box-shadow:0 10px 22px rgba(88,106,74,.18); }
    .btn.primary{ background:linear-gradient(180deg, var(--olive), var(--olive-2)); color:#fff; }
    .btn.ghost{ background:#f0e8cf; color:#33402f; }
    .err{ margin-top:8px; min-height:18px; font-size:13px; color:#b00020; }

    audio{ display:none; }
  </style>
</head>
<body>
  <!-- Nh·∫°c n·ªÅn & hi·ªáu ·ª©ng ƒÉn -->
  <audio id="bgm" src="04.mp3" autoplay loop></audio>
  <audio id="eatSfx" src="an.mp3" preload="auto"></audio>

  <main class="frame" role="main" aria-labelledby="title">
    <header>
      <div class="title" id="title">R·∫Øn sƒÉn m·ªìi ‚Äî t√™n t·ª´ng √¥: XUANHOANGVIETANH</div>
      <div class="meta">
        <div class="badge">ƒêi·ªÉm: <span id="score">0</span></div>
        <div class="badge">D√†i: <span id="length">1</span></div>
        <div class="goal" id="goalTxt">M·ª•c ti√™u: ƒë·ªß <b>16</b> ch·ªØ</div>
      </div>
    </header>

    <section class="board">
      <canvas id="game" aria-label="B√†n ch∆°i r·∫Øn sƒÉn m·ªìi"></canvas>
      <div class="progress-wrap" aria-hidden="true"><div id="progress" class="progress"></div></div>
    </section>

    <footer>ƒêi xuy√™n t∆∞·ªùng, d√πng ph√≠m <b>‚Üê ‚Üë ‚Üí ‚Üì</b> ho·∫∑c <b>W A S D</b>, kh√¥ng quay ƒë·∫ßu 180¬∞.</footer>

    <!-- Win overlay -->
    <div class="overlay" id="overlay">
      <div class="card">
        <h2>H√¨, gi·ªèi qu√°, ti·∫øp t·ª•c th·ª≠ th√°ch 2 nh√° üéâ</h2>
        <p>Nh·∫≠p <b>D√≤ng ch·ªØ 16 ch·ªØ v·ª´a th·ª±c hi·ªán</b> (g·ª£i √Ω: <i>XUANHOANGVIETANH</i>)</p>
        <input id="answer" class="inp" placeholder="Nh·∫≠p 16 ch·ªØ IN HOA, kh√¥ng d·∫•u" maxlength="20" />
        <div class="cta">
          <button class="btn ghost" id="retryBtn">Ch∆°i l·∫°i</button>
          <button class="btn primary" id="submitBtn">N·ªôp</button>
        </div>
        <div id="err" class="err" aria-live="polite"></div>
      </div>
    </div>
  </main>

  <script>
    // ====== Chu·ªói ch·ªØ tr√™n th√¢n ======
    const LETTERS = Array.from("XUANHOANGVIETANH"); // 16 k√Ω t·ª±
    const GOAL_SEGMENTS = LETTERS.length;

    // ====== ·∫¢nh cho ƒë·∫ßu r·∫Øn & m·ªìi tiramisu ======
    const imgHead = new Image(); imgHead.src = 'vietanh.png';
    const imgFoodFace = new Image(); imgFoodFace.src = 'xuanhoang.png';

    // ====== √Çm thanh ======
    const bgm = document.getElementById('bgm');
    const eatSfx = document.getElementById('eatSfx');
    bgm.volume = 0.6;
    (async () => { try { await bgm.play(); } catch(e) {} })();
    addEventListener('keydown', () => { if(bgm.paused){ bgm.play().catch(()=>{}); } }, { once:true });
    function stopBgm(){ try{ bgm.pause(); bgm.currentTime = 0; }catch(_){} }

    // ====== Canvas 600x600 (scale DPR) ======
    const PIXELS = 600, GRID = 20, CELL = Math.floor(PIXELS/GRID);
    const cvs = document.getElementById("game");
    const ctx = cvs.getContext("2d");
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    cvs.style.width = PIXELS + "px"; cvs.style.height = PIXELS + "px";
    cvs.width  = Math.floor(PIXELS * dpr); cvs.height = Math.floor(PIXELS * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    // ====== M√†u s·∫Øc ======
    const COLOR_BG="#f7f1df", COLOR_GRID="rgba(0,0,0,.05)", COLOR_SNAKE="#6E815E", COLOR_SNAKE_HEAD="#586A4A", COLOR_TEXT="#ffffff";

    // ====== HUD ======
    const scoreEl = document.getElementById("score");
    const lenEl = document.getElementById("length");
    const progressEl = document.getElementById("progress");
    const overlay = document.getElementById("overlay");
    const answerInput = document.getElementById("answer");
    const submitBtn = document.getElementById("submitBtn");
    const retryBtn = document.getElementById("retryBtn");
    const errEl = document.getElementById("err");

    // ====== State & helpers ======
    let snake, dir, nextDir, food, score, loopId, lastTick=0;
    const SPEED = 110;
    function rand(n){ return Math.floor(Math.random()*n); }
    function equal(a,b){ return a.x===b.x && a.y===b.y }
    function wrap(n){ return (n<0)? GRID-1 : (n>=GRID ? 0 : n); }
    function spawnFood(){
      let p; do { p = { x: rand(GRID), y: rand(GRID) }; } while (snake.some(s=>s.x===p.x && s.y===p.y));
      return p;
    }

    function drawBoard(){
      ctx.fillStyle = COLOR_BG; ctx.fillRect(0,0,PIXELS,PIXELS);
      ctx.strokeStyle = COLOR_GRID; ctx.lineWidth = 1;
      for(let i=0;i<=GRID;i++){
        ctx.beginPath(); ctx.moveTo(i*CELL,0); ctx.lineTo(i*CELL, GRID*CELL); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,i*CELL); ctx.lineTo(GRID*CELL, i*CELL); ctx.stroke();
      }
    }
    function roundRectPath(x,y,w,h,r){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y, x+w,y+h, r);
      ctx.arcTo(x+w,y+h, x,y+h, r);
      ctx.arcTo(x,y+h, x,y, r);
      ctx.arcTo(x,y, x+w,y, r);
      ctx.closePath();
    }

    // V·∫Ω tiramisu (·∫£nh xuanhoang.png tr√™n m·∫∑t + ch·ªØ)
    function drawFood(){
      const x = food.x*CELL, y = food.y*CELL;
      const w = CELL*0.9, h = CELL*0.7;
      const cx = x + CELL/2, cy = y + CELL/2;

      // b√≥ng
      ctx.fillStyle = "rgba(214,122,61,.18)";
      ctx.beginPath(); ctx.ellipse(cx, cy + CELL*0.28, CELL*0.36, CELL*0.16, 0, 0, Math.PI*2); ctx.fill();

      const left = cx - w/2, top = cy - h/2;
      // l·ªõp b√°nh
      ctx.fillStyle = "#b8875b"; roundRectPath(left, top + h*0.55, w, h*0.35, CELL*0.12); ctx.fill();
      ctx.fillStyle = "#f3e7cf"; roundRectPath(left, top + h*0.35, w, h*0.25, CELL*0.12); ctx.fill();
      ctx.fillStyle = "#a97a50"; roundRectPath(left, top + h*0.18, w, h*0.22, CELL*0.12); ctx.fill();
      ctx.fillStyle = "#7a5a3b"; roundRectPath(left, top, w, h*0.22, CELL*0.12); ctx.fill();

      // m·∫∑t b√°nh (clip + avatar)
      const topH = h*0.22;
      ctx.save();
      roundRectPath(left, top, w, topH, CELL*0.12); ctx.clip();

      // avatar tr√≤n
      const r = Math.min(w, topH) * 0.33;
      const faceCX = cx, faceCY = top + topH*0.58;
      if(imgFoodFace.complete && imgFoodFace.naturalWidth){
        ctx.save();
        ctx.beginPath(); ctx.arc(faceCX, faceCY, r, 0, Math.PI*2); ctx.clip();
        ctx.drawImage(imgFoodFace, faceCX - r, faceCY - r, r*2, r*2);
        ctx.restore();
        ctx.strokeStyle = "rgba(255,255,255,.9)";
        ctx.lineWidth = 1.8; ctx.beginPath(); ctx.arc(faceCX, faceCY, r, 0, Math.PI*2); ctx.stroke();
      }

      // ch·ªØ "tiramisu"
      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.font = `600 ${Math.max(8, Math.floor(CELL*0.2))}px "Fira Sans", sans-serif`;
      ctx.textAlign = "center"; ctx.textBaseline = "alphabetic";
      ctx.fillText("tiramisu", cx, top + topH - 2);

      ctx.restore();

      // r·∫Øc b·ªôt + l√°
      ctx.fillStyle = "rgba(255,255,255,.22)";
      for(let i=0;i<12;i++){ ctx.fillRect(left + Math.random()*w, top + Math.random()*topH, 1.2, 1.2); }
      ctx.fillStyle = "#5f8a3a";
      ctx.beginPath(); ctx.ellipse(left + w*0.80, top - h*0.06, CELL*0.12, CELL*0.22, -0.8, 0, Math.PI*2); ctx.fill();
    }

    // V·∫Ω r·∫Øn: ƒë·∫ßu = vietanh.png, TH√ÇN b·∫Øt ƒë·∫ßu ch·ªØ t·ª´ X
    function drawSnake(){
      const baseFont = Math.floor(CELL * 0.48);
      for(let i=snake.length-1;i>=0;i--){
        const s = snake[i]; const px = s.x*CELL, py = s.y*CELL;
        const r = Math.floor(CELL*0.25);
        const rect = {x:px+2, y:py+2, w:CELL-4, h:CELL-4};

        if(i===0){
          // ƒë·∫ßu: n·ªÅn + ·∫£nh tr√≤n
          ctx.fillStyle = COLOR_SNAKE_HEAD;
          roundRectPath(rect.x, rect.y, rect.w, rect.h, r); ctx.fill();

          const cx = px + CELL/2, cy = py + CELL/2, rr = (CELL-8)/2 - 2;
          if(imgHead.complete && imgHead.naturalWidth){
            ctx.save();
            ctx.beginPath(); ctx.arc(cx, cy, rr, 0, Math.PI*2); ctx.clip();
            ctx.drawImage(imgHead, cx-rr, cy-rr, rr*2, rr*2);
            ctx.restore();
            ctx.strokeStyle = "rgba(255,255,255,.9)";
            ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(cx, cy, rr, 0, Math.PI*2); ctx.stroke();
          }
        } else {
          // th√¢n + ch·ªØ, B·∫ÆT ƒê·∫¶U t·ª´ X cho ƒë·ªët ngay sau ƒë·∫ßu
          ctx.fillStyle = COLOR_SNAKE;
          roundRectPath(rect.x, rect.y, rect.w, rect.h, r); ctx.fill();

          ctx.save();
          roundRectPath(rect.x, rect.y, rect.w, rect.h, r); ctx.clip();
          const bodyIndex = i - 1; // ƒë·ªët sau ƒë·∫ßu = 0 -> ch·ªØ X
          const letter = LETTERS[(bodyIndex % LETTERS.length + LETTERS.length) % LETTERS.length];
          ctx.fillStyle = COLOR_TEXT;
          ctx.font = `700 ${baseFont}px "Fira Sans", sans-serif`;
          ctx.textAlign = "center"; ctx.textBaseline = "middle";
          ctx.fillText(letter, px + CELL/2, py + CELL/2 + 0.5, CELL - 6);
          ctx.restore();
        }
      }
    }

    function render(){ drawBoard(); drawFood(); drawSnake(); }

    // ====== Game flow ======
    function resetGame(){
      snake = [{x: Math.floor(GRID/2), y: Math.floor(GRID/2)}];
      dir = {x:1,y:0}; nextDir = {x:1,y:0};
      food = spawnFood(); score = 0; lastTick = 0;
      scoreEl.textContent = score; lenEl.textContent = snake.length; progressEl.style.width = "0%";
      overlay.style.display = "none"; errEl.textContent = ""; answerInput.value = "";
      cancelAnimationFrame(loopId);
      render(); loopId = requestAnimationFrame(tick);
    }

    function updateHUD(){
      scoreEl.textContent = score;
      lenEl.textContent = snake.length;
      progressEl.style.width = Math.min(snake.length/GOAL_SEGMENTS*100, 100) + "%";
    }

    function win(){
      cancelAnimationFrame(loopId);
      overlay.style.display = "flex";
      setTimeout(()=>answerInput.focus(), 50);
    }

    function tick(ts){
      if(!lastTick) lastTick = ts;
      const delta = ts - lastTick;
      if(delta >= SPEED){ lastTick = ts; step(); render(); }
      loopId = requestAnimationFrame(tick);
    }

    function step(){
      if((nextDir.x !== -dir.x) || (nextDir.y !== -dir.y)) dir = nextDir;
      const head = { x: wrap(snake[0].x + dir.x), y: wrap(snake[0].y + dir.y) };

      // t·ª± c·∫Øt khi ch·∫°m th√¢n cho d·ªÖ
      const hitIdx = snake.findIndex(s=>equal(s, head));
      if(hitIdx !== -1){ snake = snake.slice(0, hitIdx); }

      snake.unshift(head);

      if(equal(head, food)){
        score++;
        try{ eatSfx.currentTime = 0; eatSfx.play().catch(()=>{});}catch(_){}
        food = spawnFood();
        updateHUD();
        if(snake.length >= GOAL_SEGMENTS){ win(); }
      } else {
        snake.pop();
      }
    }

    // ====== Controls ======
    const DIRS = {
      ArrowUp:{x:0,y:-1}, ArrowDown:{x:0,y:1}, ArrowLeft:{x:-1,y:0}, ArrowRight:{x:1,y:0},
      w:{x:0,y:-1}, a:{x:-1,y:0}, s:{x:0,y:1}, d:{x:1,y:0},
      W:{x:0,y:-1}, A:{x:-1,y:0}, S:{x:0,y:1}, D:{x:1,y:0}
    };
    // ‚úÖ Ch·ªâ ƒëi·ªÅu khi·ªÉn khi KH√îNG g√µ trong input/textarea & overlay ƒëang ·∫©n
    function isTypingTarget(el){
      return el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable);
    }
    addEventListener("keydown", (e)=>{
      if (isTypingTarget(e.target)) return;               // ƒëang g√µ -> kh√¥ng b·∫Øt ph√≠m
      if (overlay.style.display === 'flex') return;       // ƒëang m·ªü overlay -> b·ªè qua
      const dirKey = DIRS[e.key];
      if(dirKey){
        nextDir = dirKey;
        e.preventDefault(); // ch·∫∑n cu·ªôn trang/ph√≠m m≈©i t√™n
      }
    });

    // ====== Overlay actions ======
    retryBtn.addEventListener('click', resetGame);
    submitBtn.addEventListener('click', submitAnswer);
    answerInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ submitAnswer(); } });

    // Chu·∫©n h√≥a KH√îNG D·∫§U + VI·∫æT HOA + b·ªè kho·∫£ng tr·∫Øng
    function normalizeNoDiacritics(str){
      return (str||"")
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')  // b·ªè d·∫•u
        .replace(/ƒë/gi, m => m==='ƒë'?'d':'D')             // ƒë/ƒê
        .toUpperCase().replace(/\s+/g,'');                // vi·∫øt hoa + b·ªè c√°ch
    }

    function submitAnswer(){
      const val = normalizeNoDiacritics(answerInput.value);
      if(val === "XUANHOANGVIETANH"){
        stopBgm();
        window.location.href = "05.html";
      } else {
        errEl.textContent = "Ch∆∞a ƒë√∫ng r·ªìi üòÖ Ch∆°i l·∫°i nh√©!";
        setTimeout(resetGame, 600);
      }
    }

    // ====== Start ======
    resetGame();
  </script>
</body>
</html>
