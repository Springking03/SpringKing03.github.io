<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>B·∫Øn cung c·ª©u ng∆∞·ªùi y√™u</title>

<link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;600;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --cream:#F4EEDC; --paper:#FFF8E8; --olive:#586A4A; --olive2:#45563D;
    --ink:#24301f; --stroke:rgba(0,0,0,.06); --shadow:0 14px 34px rgba(0,0,0,.18);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:"Fira Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--cream); color:var(--ink);
    display:flex; align-items:center; justify-content:center; padding:16px;
  }
  .frame{
    width:min(1100px,96vw);
    background:linear-gradient(180deg,var(--paper),#FFF3D8);
    border:1px solid var(--stroke); border-radius:28px; box-shadow:var(--shadow);
    padding:16px; position:relative; overflow:hidden;
  }
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
  .title{font-weight:900;color:var(--olive2);letter-spacing:.02em}
  .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .badge{background:var(--olive);color:#fff;padding:6px 12px;border-radius:12px;font-weight:800}
  .tip{font-size:13px;color:#586651;opacity:.95}

  .stage-wrap{display:grid;place-items:center}
  #stage{
    width:min(1000px,94vw);height:calc(min(1000px,94vw)*0.56);
    background:#f7f1df;border-radius:20px;border:1px solid rgba(0,0,0,.06);
    box-shadow:inset 0 0 0 6px rgba(233,223,194,.75),0 10px 24px rgba(0,0,0,.12);
    display:block;
  }

  /* overlays (z-index r√µ r√†ng) */
  .overlay{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.28);backdrop-filter: blur(6px);-webkit-backdrop-filter: blur(6px);
  }
  #startOverlay{z-index:6}
  #howOverlay{z-index:6}
  #videoOverlay{z-index:10;display:none}
  #quizOverlay{z-index:11;display:none}

  .dialog{
    background:#fff;border-radius:22px;padding:22px 24px;text-align:center;width:min(620px,92vw);
    box-shadow:0 18px 46px rgba(0,0,0,.22);border:1px solid rgba(0,0,0,.06)
  }
  .dialog h2{font-weight:900;color:var(--olive2);margin-bottom:6px;font-size:24px}
  .dialog p{color:#5a6a51;margin-bottom:14px}
  .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  .btn{padding:12px 16px;border-radius:14px;border:none;font-weight:800;cursor:pointer;box-shadow:0 10px 22px rgba(88,106,74,.18)}
  .btn.primary{background:linear-gradient(180deg,var(--olive),var(--olive2));color:#fff}
  .btn.ghost{background:#f0e8cf;color:#33402f}

  /* quiz */
  .choices{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px}
  .choice{border:1px solid rgba(0,0,0,.08);background:#fff;border-radius:14px;padding:12px;cursor:pointer;font-weight:800;text-align:center;box-shadow:0 6px 14px rgba(0,0,0,.08)}
  .choice:hover{background:#f8f3e4}

  /* help bubble */
  .help{
    position:fixed;padding:6px 10px;border-radius:12px;background:#fff;color:#d83b3b;font-weight:900;
    border:1px solid rgba(0,0,0,.08);box-shadow:0 8px 16px rgba(0,0,0,.12);
    transform:translate(-50%,-50%);z-index:8;pointer-events:none
  }

  /* video 1/4 m√†n, gi·ªØa c·∫£ d·ªçc/ngang */
  #quizVideo{
    width:25vw;height:auto;max-width:420px;max-height:40vh;border-radius:18px;
    outline:0;border:2px solid rgba(255,255,255,.85);box-shadow:0 18px 46px rgba(0,0,0,.35);background:#000
  }

  /* BAR FX khi ƒë√∫ng ƒë√°p √°n */
  #barFX{
    position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:12;
    background:
      radial-gradient(1200px 600px at 50% 120%, rgba(255,0,90,.15), transparent 60%),
      radial-gradient(900px 400px at 50% -20%, rgba(0,150,255,.15), transparent 60%),
      rgba(0,0,0,.35);
    overflow:hidden;
  }
  .bar-cones::before,.bar-cones::after{
    content:"";position:absolute;top:50%;left:50%;width:160vw;height:160vw;transform:translate(-50%,-50%);
    background:conic-gradient(from 0deg,
      rgba(255,230,0,.24),transparent 20%,
      rgba(255,0,150,.2),transparent 40%,
      rgba(0,200,255,.24),transparent 60%,
      rgba(0,255,160,.2),transparent 80%,
      rgba(255,230,0,.24));
    filter:blur(18px);mix-blend-mode:screen;animation:spin 8s linear infinite;
  }
  .bar-cones::after{animation-direction:reverse;animation-duration:12s;opacity:.85}
  @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
  .bar-text{position:relative;text-align:center;z-index:2;font-weight:900;letter-spacing:.02em;color:#fff;
    text-shadow:0 0 8px rgba(255,255,255,.65),0 0 26px rgba(255,0,170,.55),0 0 48px rgba(0,180,255,.45)}
  .bar-text h2{font-size:clamp(28px,5vw,52px);margin-bottom:8px}
  .bar-text p{font-size:clamp(16px,2.6vw,22px)}
  .spark{position:absolute;width:8px;height:8px;border-radius:50%;pointer-events:none;filter:blur(.2px)}

  audio{display:none}
</style>
</head>
<body>
  <!-- √Çm thanh -->
  <audio id="bgm" src="bgm.mp3" loop></audio>
  <audio id="shootSfx" src="shoot.mp3" preload="auto"></audio>
  <audio id="banSfx"   src="ban.mp3" preload="auto"></audio>
  <audio id="hitSfx"   src="hit.mp3" preload="auto"></audio>
  <audio id="chutSfx"  src="chut.mp3" preload="auto"></audio>
  <audio id="barSong"  src="bar.mp3" preload="auto"></audio>

  <div class="frame">
    <header>
      <div class="title">B·∫ÆN CUNG C·ª®U NG∆Ø·ªúI Y√äU</div>
      <div class="meta">
        <div class="badge">Qu√°i c√≤n: <span id="remain">5</span>/5</div>
        <div class="badge">B·∫Øn tr√∫ng: <span id="hits">0</span></div>
        <div class="tip">K√©o & th·∫£ ƒë·ªÉ b·∫Øn ‚Äî m≈©i t√™n bay v√≤ng v√≤ng r·ªìi v·∫´n tr√∫ng üéØ</div>
      </div>
    </header>

    <div class="stage-wrap">
      <canvas id="stage" width="1000" height="560" aria-label="S√¢n b·∫Øn cung"></canvas>
    </div>

    <!-- b·∫Øt ƒë·∫ßu -->
    <div class="overlay" id="startOverlay">
      <div class="dialog">
        <h2>B·∫Øt ƒë·∫ßu c·ª©u ng∆∞·ªùi y√™u ch·ª©? üíò</h2>
        <p>K√©o d√¢y cung theo b·∫•t k·ª≥ h∆∞·ªõng n√†o ƒë·ªÉ ng·∫Øm. L·ª±c k√©o quy·∫øt ƒë·ªãnh t·ªëc ƒë·ªô m≈©i t√™n & ƒë·ªô ‚Äúh·ªÅ h·ªÅ‚Äù.</p>
        <div class="actions">
          <button class="btn ghost"  id="howBtn">H∆∞·ªõng d·∫´n</button>
          <button class="btn primary" id="startBtn">B·∫Øt ƒë·∫ßu</button>
        </div>
      </div>
    </div>

    <!-- h∆∞·ªõng d·∫´n -->
    <div class="overlay" id="howOverlay" style="display:none">
      <div class="dialog">
        <h2>C√°ch ch∆°i</h2>
        <p>Gi·ªØ chu·ªôt/ng√≥n tay ƒë·ªÉ k√©o d√¢y, th·∫£ ra ƒë·ªÉ b·∫Øn. M≈©i t√™n xo√°y ‚Äì l·∫Øc ‚Äì r·ªìi t·ª± kh√≥a m·ª•c ti√™u. Tr√∫ng ‚Üí qu√°i r∆°i kh·ªèi b·∫ßu tr·ªùi.</p>
        <div class="actions"><button class="btn primary" id="backToStart">Quay l·∫°i</button></div>
      </div>
    </div>

    <!-- VIDEO 05.mp4 -->
    <div class="overlay" id="videoOverlay">
      <video id="quizVideo" playsinline></video>
    </div>

    <!-- quiz -->
    <div class="overlay" id="quizOverlay">
      <div class="dialog">
        <h2 style="margin-bottom:8px">B·∫°n ƒë√£ c·ª©u ƒë∆∞·ª£c ng∆∞·ªùi y√™u! ü•πüíû</h2>
        <p style="margin-bottom:10px;">Tr·∫£ l·ªùi c√¢u h·ªèi nhen‚Ä¶</p>
        <h3>C√¢u h·ªèi</h3>
        <div class="choices">
          <button class="choice" data-a="banhxeo">A. B√°nh x√®o</button>
          <button class="choice" data-a="banhcuon">B. B√°nh cu·ªën</button>
          <button class="choice" data-a="gaquay">D. G√† quay</button>
          <button class="choice" data-a="thitxaxiu">E. Th·ªãt x√° x√≠u</button>
        </div>
      </div>
    </div>

    <!-- BAR FX khi ƒë√∫ng -->
    <div id="barFX">
      <div class="bar-cones"></div>
      <div class="bar-text">
        <h2>ƒê√∫ng r·ªìi, gi·ªèi qu√°! ‚ú®</h2>
        <p>S√°ng t·∫°o ‚Äî l·∫•p l√°nh x·∫≠p x√¨nh nh∆∞ bar th·∫≠t üéâ</p>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== Audio =====
  const bgm = document.getElementById('bgm');
  const shootSfx = document.getElementById('shootSfx');
  const banSfx   = document.getElementById('banSfx');
  const hitSfx   = document.getElementById('hitSfx');
  const chutSfx  = document.getElementById('chutSfx');
  const barSong  = document.getElementById('barSong');
  bgm.volume=0.5; barSong.volume=0.9; chutSfx.volume=0.9;

  const resumeAudio = () => { bgm.play().catch(()=>{}); window.removeEventListener('pointerdown', resumeAudio); };
  window.addEventListener('pointerdown', resumeAudio);

  // ===== Overlays =====
  const startOverlay = document.getElementById('startOverlay');
  const howOverlay   = document.getElementById('howOverlay');
  const videoOverlay = document.getElementById('videoOverlay');
  const quizOverlay  = document.getElementById('quizOverlay');
  const quizVideo    = document.getElementById('quizVideo');
  quizVideo.src = '05.mp4';

  document.getElementById('howBtn').onclick = ()=>{ startOverlay.style.display="none"; howOverlay.style.display="flex"; };
  document.getElementById('backToStart').onclick = ()=>{ howOverlay.style.display="none"; startOverlay.style.display="flex"; };
  document.getElementById('startBtn').onclick = ()=>{
    startOverlay.style.display="none";
    startGame();
    bgm.play().catch(()=>{});
  };

  // ===== Canvas & world =====
  const cvs = document.getElementById('stage');
  const ctx = cvs.getContext('2d');
  const W = cvs.width, H = cvs.height;
  const GROUND_Y = H - 60, SKY = '#f7f1df', GROUND = '#e9dfc4';

  const headArcher = new Image(); headArcher.src = 'vietanh.png';
  const headLover  = new Image(); headLover.src = 'xuanhoang.png';

  const archer = { x:130, y:GROUND_Y-110, w:52, h:112, aim:false, pull:0, aimVec:{x:120,y:-30}, drawHand:{x:0,y:0} };
  const cage = { x: W-190, y:GROUND_Y-170, w:130, h:170, open:false };
  const lover= { x:cage.x+65, y:cage.y+128, freed:false, jumpAmp:0 };

  const ENEMY_COUNT = 5;
  const enemies = Array.from({length:ENEMY_COUNT}, (_,i)=>makeEnemy(i));
  function makeEnemy(i){
    const y = 90 + i*50 + Math.random()*30;
    const x = W*0.45 + Math.random()*W*0.45;
    return { x, y, r:18+Math.random()*8, t:Math.random()*6.28, vx:(Math.random()<.5?-1:1)*(0.6+Math.random()*0.6),
             alive:true, falling:false, landed:false, vy:0, rot:0 };
  }

  const remainEl = document.getElementById('remain');
  const hitsEl = document.getElementById('hits');
  remainEl.textContent = ENEMY_COUNT;
  let hits=0;

  const arrows=[];
  let last=0, running=false, victory=false, heartsT=0;
  let hugging=false, hugStart=0, videoShown=false;

  // ===== Input =====
  let pId=null;
  cvs.addEventListener('pointerdown', e=>{
    const p = local(e);
    if(p.x < 320 && p.y > archer.y-160){
      pId=e.pointerId; cvs.setPointerCapture(pId);
      archer.aim=true; archer.pull=0; archer.aimStart=p;
      const anchor = { x: archer.x+24, y: archer.y-26 };
      archer.drawHand = anchor;
    }
  });
  cvs.addEventListener('pointermove', e=>{
    if(archer.aim && e.pointerId===pId){
      const p = local(e);
      const anchor = { x: archer.x+24, y: archer.y-26 };
      const dx = p.x - anchor.x, dy = p.y - anchor.y;
      const len = Math.min(200, Math.hypot(dx,dy)), ang = Math.atan2(dy,dx);
      archer.pull = len;
      archer.aimVec = { x: Math.cos(ang)*Math.max(60, len), y: Math.sin(ang)*Math.max(30, len*0.7) };
      archer.drawHand = { x: anchor.x + Math.cos(ang)*len, y: anchor.y + Math.sin(ang)*len };
    }
  });
  cvs.addEventListener('pointerup', e=>{
    if(archer.aim && e.pointerId===pId){
      fireArrow();
      archer.aim=false; archer.pull=0; cvs.releasePointerCapture(pId); pId=null;
    }
  });
  function local(e){ const r = cvs.getBoundingClientRect(); return { x:(e.clientX-r.left)*(W/r.width), y:(e.clientY-r.top)*(H/r.height) }; }

  // ===== Fire =====
  function fireArrow(){
    const targets = enemies.filter(e=>e.alive && !e.falling && !e.landed);
    if(!targets.length) return;

    const from = { x: archer.x+42, y: archer.y-26 };
    const guess = archer.aimVec || {x:120,y:-30};
    const aimY = from.y + guess.y;
    let target = targets.reduce((best,e)=>{ const d=Math.abs(e.y-aimY); return (!best||d<best.d)?{e,d}:best; }, null).e;

    const c1 = { x: from.x + guess.x*0.35, y: from.y + guess.y*0.35 - 80 };
    const c2 = { x: from.x + guess.x*0.85, y: from.y + guess.y*0.85 + 90 };
    const to  = { x: target.x, y: target.y };

    const pullNorm = Math.min(1, (archer.pull||100)/200);
    const speed = 0.010 + pullNorm*0.018;
    const wobAmp = 26 + pullNorm*22;
    const wobFreq = 6 + Math.random()*4;

    arrows.push({ t:0, from, c1, c2, to, targetRef:target, speed, wobAmp, wobFreq, done:false, lastPos:{...from}, angle:0 });

    try{ shootSfx.currentTime=0; shootSfx.play().catch(()=>{});}catch{}
    setTimeout(()=>{ try{ banSfx.currentTime=0; banSfx.play().catch(()=>{});}catch{} }, 30);
  }

  // ===== Loop =====
  function loop(ts){
    if(!last) last=ts; const dt=(ts-last)/16.67; last=ts;

    // enemies
    enemies.forEach(en=>{
      if(!en.alive) return;
      if(en.falling){
        if(!en.landed){
          en.vy += 0.7*dt; en.y += en.vy*dt; en.rot += 0.09*dt;
          if(en.y + en.r >= GROUND_Y){ en.y = GROUND_Y - en.r; en.landed = true; }
        }
        return;
      }
      en.t += 0.04*dt;
      en.x += en.vx*dt*1.2;
      en.y += Math.sin(en.t)*0.8*dt*6;
      if(en.x < W*0.40) en.x = W*0.95;
      if(en.x > W*0.95) en.x = W*0.40;
    });

    // arrows
    arrows.forEach(a=>{
      if(a.done) return;
      a.t += a.speed*dt;
      if(a.t>0.55){ const trg=a.targetRef; if(trg&&trg.alive&&!trg.falling&&!trg.landed){ a.to.x=trg.x; a.to.y=trg.y; } }
      if(a.t>=1){ hit(a); a.done=true; }
    });

    // help bubbles
    if(!cage.open && !lover.freed) maybeHelp();

    lover.jumpAmp *= 0.92;

    // ===== draw (tr√°nh √¥m x2) =====
    ctx.fillStyle = SKY; ctx.fillRect(0,0,W,H);
    ctx.fillStyle = '#ffffffb0';
    for(let i=0;i<3;i++){ const cx = (i*320 + (performance.now()/30)%W); cloud(cx%W, 80+i*30); }
    ctx.fillStyle = GROUND; ctx.fillRect(0,GROUND_Y,W,H-GROUND_Y);

    if(victory && hugging){
      drawHug();
    } else {
      drawCageAndLover();
      drawArcher();
    }
    enemies.forEach(en=>{ if(en.alive) drawEnemy(en); });
    arrows.forEach(a=>{ if(!a.done) drawArrow(a); });
    if(archer.aim && !(victory && hugging)) drawNockedArrow();

    // flow win: m·ªü l·ªìng -> √¥m -> video -> quiz
    if(victory){
      if(!hugging){
        if(!lover.freed){ lover.freed=true; lover.x=cage.x + cage.w/2; }
        lover.x -= 2.6;
        if(lover.x <= archer.x+66){ hugging=true; hugStart=performance.now(); try{chutSfx.currentTime=0;chutSfx.play().catch(()=>{});}catch{} }
      } else {
        if(ts - heartsT > 110){ heartsT = ts; spawnHeart(archer.x+60, archer.y-46); }
        if(!videoShown && (performance.now() - hugStart > 1600)){
          videoShown = true; showVideoThenQuiz();
        }
      }
    }

    if(running) requestAnimationFrame(loop);
  }

  // ===== Draw helpers =====
  function cloud(x,y){ ctx.beginPath(); ctx.arc(x,y,22,0,Math.PI*2); ctx.arc(x+26,y+6,26,0,Math.PI*2); ctx.arc(x+56,y-2,18,0,Math.PI*2); ctx.fill(); }
  function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function drawHead(img,cx,cy,r){
    const s=r*2;
    if(img.complete&&img.naturalWidth){
      ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.clip();
      ctx.drawImage(img,cx-r,cy-r,s,s); ctx.restore();
      ctx.strokeStyle='rgba(255,255,255,.85)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
    } else { ctx.fillStyle='#d9b99a'; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); }
  }

  function drawArcher(){
    ctx.fillStyle = '#7c8f6c'; roundRect(archer.x, archer.y, archer.w, archer.h, 10); ctx.fill();
    ctx.strokeStyle='#33402f'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(archer.x+18, archer.y+archer.h); ctx.lineTo(archer.x, archer.y+archer.h+34);
    ctx.moveTo(archer.x+34, archer.y+archer.h); ctx.lineTo(archer.x+52, archer.y+archer.h+34); ctx.stroke();

    drawHead(headArcher, archer.x+26, archer.y-16, 22);

    ctx.strokeStyle='#d9b99a'; ctx.lineWidth=6; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(archer.x+18, archer.y-8); ctx.lineTo(archer.x+56, archer.y+16); ctx.stroke();

    const anchor = { x: archer.x+24, y: archer.y-26 };
    const hand = archer.aim ? archer.drawHand : anchor;
    ctx.beginPath(); ctx.moveTo(archer.x+20, archer.y-10); ctx.lineTo(hand.x, hand.y); ctx.stroke();

    ctx.strokeStyle='#6b3d24'; ctx.lineWidth=6; ctx.beginPath(); ctx.arc(archer.x+36, archer.y+20, 54, -Math.PI/2, Math.PI/2); ctx.stroke();
    ctx.strokeStyle='#caa27f'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(archer.x+36, archer.y-34); ctx.lineTo(hand.x, hand.y); ctx.lineTo(archer.x+36, archer.y+74); ctx.stroke();
  }
  function drawNockedArrow(){
    const anchor = { x: archer.x+24, y: archer.y-26 };
    const hand = archer.drawHand;
    const dir = Math.atan2(hand.y - anchor.y, hand.x - anchor.x);
    const pos = { x: hand.x + Math.cos(dir)*-6, y: hand.y + Math.sin(dir)*-6 };
    drawArrowShape(pos.x, pos.y, dir);
  }
  function drawCageAndLover(){
    ctx.fillStyle='#b0a79a'; roundRect(cage.x, cage.y, cage.w, cage.h, 10); ctx.fill();
    ctx.strokeStyle='#6f675b'; ctx.lineWidth=3;
    for(let i=0;i<5;i++){ const gx=cage.x+10+i*24; ctx.beginPath(); ctx.moveTo(gx,cage.y+10); ctx.lineTo(gx,cage.y+cage.h-10); ctx.stroke(); }
    if(cage.open){ ctx.save(); ctx.translate(cage.x+cage.w-16, cage.y+12); ctx.rotate(-Math.PI/2.4); ctx.fillStyle='#a79f93'; roundRect(0,0,12,cage.h-24,4); ctx.fill(); ctx.restore(); }
    else { ctx.fillStyle='#a79f93'; roundRect(cage.x+cage.w-24, cage.y+12, 12, cage.h-24, 4); ctx.fill(); }

    const bx=lover.x, by=lover.y - Math.sin(performance.now()/160)*lover.jumpAmp;
    ctx.strokeStyle='#33402f'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(bx, by-16); ctx.lineTo(bx, by+22); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(bx, by); ctx.lineTo(bx-12, by+10);
    ctx.moveTo(bx, by); ctx.lineTo(bx+12, by+10); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(bx, by+22); ctx.lineTo(bx-10, by+42);
    ctx.moveTo(bx, by+22); ctx.lineTo(bx+10, by+42); ctx.stroke();
    drawHead(headLover, bx, by-28, 16);
  }
  function drawEnemy(en){
    ctx.save(); ctx.translate(en.x, en.y); if(en.falling) ctx.rotate(en.rot);
    ctx.fillStyle='#9b4dca22'; ctx.beginPath(); ctx.arc(0,6,en.r+10,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#9b4dca'; ctx.beginPath(); ctx.arc(0,0,en.r,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(-6,-4,4,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(6,-4,4,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#222'; ctx.beginPath(); ctx.arc(-6,-4,2,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(6,-4,2,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#b089d6'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(-en.r,0); ctx.quadraticCurveTo(-en.r-18,-14,-en.r-28,0); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(en.r,0); ctx.quadraticCurveTo(en.r+18,-14,en.r+28,0); ctx.stroke();
    ctx.restore();
  }
  function bezierPoint(a,t){ const u=1-t; return { x:u*u*u*a.from.x+3*u*u*t*a.c1.x+3*u*t*t*a.c2.x+t*t*t*a.to.x,
                                                   y:u*u*u*a.from.y+3*u*u*t*a.c1.y+3*u*t*t*a.c2.y+t*t*t*a.to.y }; }
  function drawArrow(a){
    const p=bezierPoint(a,a.t);
    const amp=a.wobAmp*Math.pow(0.85,a.t*6);
    const wx=Math.cos(a.t*a.wobFreq*Math.PI)*amp*0.25;
    const wy=Math.sin(a.t*a.wobFreq*Math.PI)*amp;
    const x=p.x+wx, y=p.y+wy;
    const dx=x-(a.lastPos.x), dy=y-(a.lastPos.y);
    a.angle=Math.atan2(dy,dx); a.lastPos={x,y};
    drawArrowShape(x,y,a.angle);
  }
  function drawArrowShape(x,y,angle){
    ctx.save(); ctx.translate(x,y); ctx.rotate(angle);
    ctx.fillStyle='#6b4b2a'; ctx.fillRect(-26,-2,30,4);
    ctx.fillStyle='#d9b38c'; ctx.beginPath(); ctx.moveTo(-30,0); ctx.lineTo(-38,-7); ctx.lineTo(-32,0); ctx.lineTo(-38,7); ctx.closePath(); ctx.fill();
    ctx.fillStyle='#5a3b27'; ctx.beginPath(); ctx.moveTo(6,0); ctx.lineTo(-2,-6); ctx.lineTo(-2,6); ctx.closePath(); ctx.fill();
    ctx.restore();
  }

  // ===== Hit =====
  function hit(a){
    const candidates = enemies.map(e=>({e})).filter(o=>o.e.alive && !o.e.falling && !o.e.landed);
    if(!candidates.length) return;
    let best=candidates[0], bd=1e9;
    candidates.forEach(o=>{ const d2=(o.e.x-a.to.x)**2+(o.e.y-a.to.y)**2; if(d2<bd){ bd=d2; best=o; } });
    const en=best.e; en.falling=true;
    try{ hitSfx.currentTime=0; hitSfx.play().catch(()=>{});}catch{}
    lover.jumpAmp = Math.min(18, lover.jumpAmp+10);
    hits++; hitsEl.textContent = hits;
    const remain = enemies.filter(e=>e.alive && !e.falling && !e.landed).length;
    remainEl.textContent = remain;
    if(remain===0 && !victory){ cage.open=true; victory=true; }
  }

  // ===== Hug =====
  function drawHug(){
    const hx = archer.x + 64, hy = archer.y - 6;
    const t = (performance.now()-hugStart)/1000, bounce = Math.sin(t*8)*3;

    // archer
    ctx.strokeStyle='#33402f'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(hx-14, hy-8 + bounce); ctx.lineTo(hx-14, hy+30 + bounce); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hx-14, hy+6 + bounce); ctx.quadraticCurveTo(hx, hy+2 + bounce, hx+14, hy+10 + bounce); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hx-14, hy+30 + bounce); ctx.lineTo(hx-26, hy+54 + bounce);
    ctx.moveTo(hx-14, hy+30 + bounce); ctx.lineTo(hx-2,  hy+54 + bounce); ctx.stroke();
    drawHead(headArcher, hx-16, hy-22 + bounce, 18);

    // lover
    ctx.beginPath(); ctx.moveTo(hx+14, hy-8 + bounce); ctx.lineTo(hx+14, hy+30 + bounce); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hx+14, hy+6 + bounce); ctx.quadraticCurveTo(hx, hy+2 + bounce, hx-14, hy+10 + bounce); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hx+14, hy+30 + bounce); ctx.lineTo(hx+26, hy+54 + bounce);
    ctx.moveTo(hx+14, hy+30 + bounce); ctx.lineTo(hx+2,  hy+54 + bounce); ctx.stroke();
    drawHead(headLover, hx+16, hy-22 + bounce, 18);
  }

  // ===== HELP bubble =====
  let helpTimer=0;
  function maybeHelp(){
    const now=performance.now();
    if(now - helpTimer > 1000){ helpTimer=now; spawnHelpBubble(); }
  }
  function spawnHelpBubble(){
    const rect = cvs.getBoundingClientRect();
    const cx = cage.x + cage.w/2;
    const sx = rect.left + (cx/W)*rect.width + (Math.random()*40-20);
    const sy = rect.top  + ((cage.y+20)/H)*rect.height;
    const el = document.createElement('div');
    el.className='help'; el.textContent='HELP';
    el.style.left=sx+'px'; el.style.top=sy+'px'; document.body.appendChild(el);
    const up=-120 - Math.random()*60, drift=(Math.random()*60-30);
    el.animate([
      {transform:'translate(-50%,-50%) scale(.9)',opacity:.95},
      {transform:`translate(${drift-50}%,${up-50}%) scale(1.1)`,opacity:0}
    ],{duration:1400,easing:'ease-out'}).onfinish=()=>el.remove();
  }

  // ===== Video -> Quiz =====
  function showVideoThenQuiz(){
    videoOverlay.style.display='flex';
    quizVideo.currentTime=0;
    quizVideo.play().catch(()=>{});
    quizVideo.onended = ()=>{
      videoOverlay.style.display='none';
      quizOverlay.style.display='flex';
    };
    videoOverlay.onclick = ()=>{ if(quizVideo.paused) quizVideo.play().catch(()=>{}); };
  }

  // ===== Quiz click =====
  quizOverlay.addEventListener('click', e=>{
    const btn = e.target.closest('.choice'); if(!btn) return;
    const ans = btn.getAttribute('data-a');
    if(ans === 'banhcuon'){ startBarFX(); }
    else{
      const dlg = quizOverlay.querySelector('.dialog');
      dlg.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:300});
    }
  });

  // ===== BAR FX =====
  const barFX = document.getElementById('barFX');
  function startBarFX(){
    quizOverlay.style.display='none';
    barFX.style.display='flex';
    try{ barSong.currentTime=0; barSong.play().catch(()=>{});}catch{}
    spawnSparks(140);
  }
  function spawnSparks(n){
    const colors=['#fff8a6','#ffd1ff','#a6fff8','#ffc6a6','#c6ffa6','#ffffff'];
    const rect=barFX.getBoundingClientRect();
    for(let i=0;i<n;i++){
      const s=document.createElement('div'); s.className='spark';
      const size=6+Math.random()*12; s.style.width=size+'px'; s.style.height=size+'px';
      s.style.left=(rect.left+rect.width/2)+'px'; s.style.top=(rect.top+rect.height/2)+'px';
      const color=colors[(Math.random()*colors.length)|0]; s.style.background=color; s.style.boxShadow=`0 0 ${8+Math.random()*18}px ${color}`;
      document.body.appendChild(s);
      const dx=(Math.random()*2-1)*rect.width*0.45; const dy=(Math.random()*2-1)*rect.height*0.35;
      const scale=0.6+Math.random()*1.4; const dur=900+Math.random()*1100;
      s.animate(
        [{transform:'translate(-50%,-50%) scale(.6)',opacity:1},
         {transform:`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(${scale})`,opacity:0}],
        {duration:dur,easing:'cubic-bezier(.2,.8,.2,1)'}
      ).onfinish=()=>s.remove();
    }
  }

  // ===== Start =====
  function startGame(){ if(running) return; running=true; requestAnimationFrame(loop); }

})();
</script>
</body>
</html>
